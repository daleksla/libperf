# libperf
## README

libperf is a library that wraps around the `perf_event_open()` syscall, to expose the Linux kernel performance counters subsystem to userspace. 

## Summarising

This is a fork from theonewolf/libperf, who wrote it due to the following:
> This document describes the libperf library implemented as an interface to a
syscall introduced in a mature form into the Linux Kernel mainline in 2009. This
interface was previously only usable via a binary tool called 'perf' included in
Linux Kernel source distributions today.
There are several key shortcomings of interfacing with the system call only
through a controlled binary.  The first is that the granularity of tracing
hardware performance counter registers and software tracepoints is at a whole
binary level.  There is no method for tracing portions of code within the
application if desired.  This is because there is no nice API exposed to
userspace developers that can interface with this system call.  The second
shortcoming is that the tool, although extensive, may not account for every
possible use case for these counters and tracepoints.  Offering a
non-restrictive API to userspace gives developers full power and freedom to
implement any functionality desired.
libperf closes this gap and provides an API for interfacing with the system
call used by the perf tool.  This provides all of the power of the tool with
the granularity of snippets of code.

This fork was created as:
- The original creator does not maintain the library
- Components of original library, if failed, would kill running process (bad for libraries)
- To include a C++ API, including an RAII container

## Building

libperf has 4 dependancies:
- A modern Linux Kernel (post v2.6.31)
- GNU make utility
- C99 conformant compiler
- CXX11 conformant compiler


Run the following steps to build the library for *use*:
- `./configure`
- `make`
- `sudo make install`

Run the following steps to build the library for *development*:
- `./bootstrap.sh`
- `./configure`
- `make`
- `sudo make install`

## Using 

### C API

Include `libperf.h', and call `libperf_initialise' function - this provides a handle to be used for future library calls.

The available counters are defined in the 'enum libperf_tracepoint'; 'libperf_enablecounter' and 'libperf_disablecounter' are used to enable and
disable individual counters as desired. 'libperf_readcounter' is then used to read a single 64 bit counter from the library.

Use `libperf_log` to then obtin a log of all counters - this appends logs into a file named after the PID value passed
into `libperf_initialise`.  If the pid value is -1, then the library will use
the system call 'gettid' to obtain the thread id of the current running thread
of execution (equivalent to the pid of a single-threaded application).  Also,
setting the 'cpu' value to -1 when initialising causes the libperf counters to
count across all CPUs for a given thread id.

Finally, call `libperf_close` to shut down the library

`libperf_unit_test` performs a small test of the library, allocating 1 Gb (Gigabyte) of memory, touching each byte, and logging performance counters.

### Example (C API)

Example using some of the functions in an example:

```
     #include <inttypes.h> /* for PRIu64 definition */
     #include <stdint.h>   /* for uint64_t */ 
     #include <stdio.h>    /* for printf family */
     #include <stdlib.h>   /* for EXIT_SUCCESS definition */
     #include "libperf.h"  /* standard libperf include */

     int main(int argc, char* argv[])
     {
          struct libperf_data* pd = libperf_initialize(-1,-1); /* init lib */
          libperf_enablecounter(pd, LIBPERF_COUNT_HW_INSTRUCTIONS);
                                                /* enable HW counter */
          uint64_t counter = libperf_readcounter(pd,
                                                 LIBPERF_COUNT_HW_INSTRUCTIONS);
                                                /* obtain counter value */
          libperf_disablecounter(pd, LIBPERF_COUNT_HW_INSTRUCTIONS);
                                                /* disable HW counter */

          fprintf(stdout, "counter read: %"PRIu64"\n", counter); /* printout */

          FILE* log = libperf_getlogger(pd); /* get log file stream */
          fprintf(log, "custom log message\n"); /* print a custom log message */

          libperf_finalize(pd, 0); /* log all counter values */

          return EXIT_SUCCESS; /* success exit value */
     }
```

### CXX API

All functions from the C API are put into namespace `libperf`, with exception `std::runtime_error` being thrown if errors occur. Furthermore, the `libperf::Perf` approaches access to this library via the RAII idiom 

### Compiling 

Pass `pkg-config --libs --cflags libperf` as an argument to your compiler of choice when you compile against the library

---

See LICENSE for terms of usage.
